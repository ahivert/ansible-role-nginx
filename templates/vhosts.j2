server {
    listen {{ item.value.listen | default('80 default_server') }};
{% if item.value.server_name is defined %}
    server_name {{ item.value.server_name }};
{% endif %}

{% if item.value.root is defined %}
    root {{ item.value.root }};
{% endif %}
{% if item.value.index is defined %}
    index {{ item.value.index }};
{% endif %}

{% if item.value.error_page is defined %}
    error_page {{ item.value.error_page }};
{% endif %}
{% if item.value.access_log is defined %}
    access_log {{ item.value.access_log }};
{% endif %}
{% if item.value.error_log is defined %}
    error_log {{ item.value.error_log }} error;
{% endif %}

{% if item.value.return is defined %}
    return {{ item.value.return }};
{% endif %}

{% for path, location_values in item.value.locations.iteritems() %}
    location {{ path }} {
{% if location_values.proxy_pass is defined %}
        proxy_pass {{ location_values.proxy_pass }};
{% endif %}

{% if location_values.proxy_set_header is defined %}
{% for proxy_header in location_values.proxy_set_header %}
        proxy_set_header {{ proxy_header }};
{% endfor %}
{% endif %}

{% if item.value.extra_parameters is defined %}
    {{ item.value.extra_parameters }}
{% endif %}
    }
{% endfor %}

}
