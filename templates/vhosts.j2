server {
{% if item.value.https_enable is defined and item.value.https_enable %}
    listen {{ item.value.listen | default('443 ssl') }};
    ssl_certificate {{ item.value.ssl_certificate_path }};
    ssl_certificate_key {{ item.value.ssl_certificate_key_path }};
    ssl_trusted_certificate {{ item.value.ssl_trusted_certificate }};
{% if ssl_trusted_certificate is defined %}
    ssl_stapling on;
    ssl_stapling_verify on;
{% endif %}
    ssl_protocols {{ item.value.ssl_protocols | default('TLSv1.2') }};

    ssl_ecdh_curve {{ item.value.ssl_ecdh_curve | default('secp384r1') }};

    ssl_ciphers {{ item.value.ssl_ecdh_curve | default('EECDH+AESGCM:EECDH+AES') }};
    ssl_prefer_server_ciphers {{ item.value.ssl_prefer_server_ciphers | default('on') }};

    ssl_session_cache {{ item.value.ssl_session_cache | default('shared:SSL:10m') }};
    ssl_session_timeout {{ item.value.ssl_session_timeout | default('5m') }};
    ssl_session_tickets {{ item.value.ssl_session_tickets | default('off') }};
{% if strict_transport_security_header is defined %}
    add_header Strict-Transport-Security "{{ strict_transport_security_header}}";
{% endif %}

{% else %}
    listen {{ item.value.listen | default('80 default_server') }};
{% endif %}

{% if item.value.server_name is defined %}
    server_name {{ item.value.server_name }};
{% endif %}

{% if item.value.root is defined %}
    root {{ item.value.root }};
{% endif %}

    index {{ item.value.index | default('index.html index.htm') }};

{% if item.value.error_page is defined %}
    error_page {{ item.value.error_page }};
{% endif %}
{% if item.value.access_log is defined %}
    access_log {{ item.value.access_log }};
{% endif %}
{% if item.value.error_log is defined %}
    error_log {{ item.value.error_log }} error;
{% endif %}

{% if item.value.return is defined %}
    return {{ item.value.return }};
{% endif %}

{% if item.value.locations is defined %}
{% for path, parameters in item.value.locations.iteritems() %}
    location {{ path }} {
{% for line in parameters %}
        {{ line }};
{% endfor %}
    }
{% endfor %}
{% endif %}


{% if item.value.extra_parameters is defined %}
    {{ item.value.extra_parameters }}
{% endif %}
}

{% if item.value.redirect_to_https is defined and item.value.redirect_to_https %}
server {
    listen {{ item.value.redirect_https_from | default('80') }};
{% if item.value.server_name is defined %}
    server_name {{ item.value.server_name }};
{% endif %}
    return 301 https://$host$request_uri;
}
{% endif %}
